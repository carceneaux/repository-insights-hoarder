# Github Action: Repository Insight Tracker

This GitHub Action updates the repository statistics including the number of stargazers, commits, contributors, traffic views, and clones.
The results are stored in a JSON or CSV file and committed to a specified branch in the repository.

1. Collects statistics on stargazers, commits, contributors, traffic views, and clones using the Github Rest API and GraphQL API.
2. Writes the statistics to a JSON or CSV file under `<directory>/<owner>/<repository>/stats.<format>`.
3. Commits the file to a specified branch in the repository.
4. Pipes the data as output to the next action, for further processing.

### Inputs

| Input Name    | Description                                                      | Required | Default                       |
| ------------- | ---------------------------------------------------------------- | -------- | ----------------------------- |
| `insights_token`| GitHub token used to retrieve repository insights.             | Yes      | `${{ secrets.INSIGHTS_TOKEN }}` |
| `commit_token`| GitHub token used to save insights to storage repository.        | Yes      | `${{ secrets.INSIGHTS_TOKEN }}` |
| `owner`       | The repository owner or organization where insights will be gathered. | No       | `${{ github.owner }}`         |
| `all_repos`   | If true, the action will gather insights for all repositories under the specified owner or organization. | No       | `false`         |
| `repository`  | The repository to track insights for.                            | No       | `${{ github.repository }}`    |
| `storage_owner` | The repository owner or organization where insights will be stored. | No       | `${{ github.owner }}`         |
| `storage_repo`  | The repository where insights will be stored.                       | No       | `${{ github.repository }}`    |
| `branch`      | The branch to commit the insights file to.                       | No       | `repository-insights`         |
| `directory`    | The root directory where insights file will be stored.         | No       | `.insights`                |
| `format`      | The format for the insights file, either 'json' or 'csv'.       | No       | `csv`                         |

## üìó Documentation

### 1. Generate a Github Token
The action requires the repository to fetch a Github token other than the tone generated by the action itself, as it accesses traffic/views and clones. This access can only be granted through a private token.

To generate this and apply this token, follow the steps below:

1. Go to Github Settings in the upper right corner,

2. Go to Developer Settings,

3. Generate a new token,
    * In the developer settings, click on Personal Access Token (PAT),
    * Click Generate new token,
    * Give your token a descriptive name (e.g., `Repository Stats Action`),
    * Under Select scopes, choose the following scopes:
        * `repo`: Full control of private repositories. Required if your repository is private.
        * `workflow`: Update GitHub Action workflows.
    * A fine-grained PAT requires the following permissions:
        * Repository access set to `All repositories` or `Only select repositories`
          * For the latter, make sure to include the repository where the action is run and any repositories gathering insights from (if different).
              * Repository permissions
                  * `Administration`: Read-only *(This is required to retrieve insights.)*
                  * `Contents`: Read and write *(This is required to save insights to a repository.)*
    * Click Generate token
    * Copy the token to your clipboard. You won‚Äôt be able to see it again.
4. Add the Token to Your Repository:
    * Navigate to your repository on GitHub.
    * Go to Settings > Secrets and variables > Actions > New repository secret.
    * Name the secret `TOKEN` (or another name of your choice).
    * Paste the token you copied earlier and click Add secret.


### 2. Add a workflow file

To use this action in your repository, create a workflow file (e.g., `.github/workflows/update-stats.yml`) with the contents below.

This is the minimum configurable parameters to run the job,
and will collect insights daily, on the repository that the workflow sits in,
and store these as a CSV file, on the branch repository-insights, in directory `/.insights/<owner>/<repository>/stats.csv`.

#### 2.1 Simple example

```yaml
name: Collect repository insights

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Collect insights
        uses: carceneaux/repository-insight-hoarder@v1.0.0
        with:
          github-token: ${{ secrets.TOKEN }}
```

#### 2.2 Example with all input parameters

Here is an example with full configurability in the action, that fetches insights from another repository (that you own), and subsequently writes the output to console.
```yaml
name: Collect repository insights

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Collect insights
        id: collect-insights
        uses: carceneaux/repository-insight-hoarder@v1.0.0
        with:
          github-token: ${{ secrets.TOKEN }}
          branch: 'repository-insights'
          format: 'csv'
          directory: '.insights'
          owner: 'carceneaux'
          repository: 'planning-poker'
      - name: Write insights to console
        run: |
          echo "Stargazers: ${{ steps.collect-insights.outputs.stargazers }}"
          echo "Commits: ${{ steps.collect-insights.outputs.commits }}"
          echo "Contributors: ${{ steps.collect-insights.outputs.contributors }}"
          echo "Traffic Views Yesterday: ${{ steps.collect-insights.outputs.traffic_views }}"
          echo "Unique Traffic Views Yesterday: ${{ steps.collect-insights.outputs.traffic_uniques }}"
          echo "Clones Yesterday: ${{ steps.collect-insights.outputs.clones_count }}"
          echo "Unique Clones Yesterday: ${{ steps.collect-insights.outputs.clones_uniques }}"
```

## ‚úç Contributions

We welcome contributions from the community! We encourage you to create [issues](https://github.com/carceneaux/repository-insights-hoarder/issues/new/choose) for Bugs & Feature Requests and submit Pull Requests. For more detailed information, refer to our [Contributing Guide](CONTRIBUTING.md).

## ü§ùüèæ License

* [MIT License](LICENSE)

## ü§î Questions

If you have any questions or something is unclear, please don't hesitate to [create an issue](https://github.com/carceneaux/repository-insights-hoarder/issues/new/choose) and let us know!
